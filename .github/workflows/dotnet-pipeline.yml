name: DotNet CI + Tagged Release

on:

  push:

    branches:

      - main

    tags:

      - 'v*'

  workflow_dispatch:

jobs:

  build:

    name: Build and Publish

    runs-on: ubuntu-latest

    steps:

      - name: Checkout source code

        uses: actions/checkout@v4

      - name: Setup .NET 8

        uses: actions/setup-dotnet@v4

        with:

          dotnet-version: 8.0.x

      - name: Restore

        run: dotnet restore MyDotNetApp/MyDotNetApp.csproj

      - name: Build

        run: dotnet build MyDotNetApp/MyDotNetApp.csproj --configuration Release --no-restore

      - name: Publish

        run: dotnet publish MyDotNetApp/MyDotNetApp.csproj -c Release -o publish

      - name: Upload publish artifact

        uses: actions/upload-artifact@v4

        with:

          name: dotnet-app

          path: publish/


  deploy:

    name: Create GitHub Release

    runs-on: ubuntu-latest

    needs: build

    if: startsWith(github.ref, 'refs/tags/')

    steps:

      - name: Download published artifact

        uses: actions/download-artifact@v4

        with:

          name: dotnet-app

          path: release-files

      - name: Create GitHub Release and Attach Files

        uses: softprops/action-gh-release@v2

        with:

          files: release-files/**

        env:

          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
 
